
name: Grilo SC Analysis for Java (Maven/Gradle)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch: {}

jobs:
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # DETECÃ‡ÃƒO E INSTALAÃ‡ÃƒO DINÃ‚MICA
      - name: Setup Build Environment
        id: setup_env
        run: |
          # 1. Tenta achar Maven
          POM_PATH=$(find . -maxdepth 3 -name "pom.xml" -not -path "*/target/*" | head -n 1)
          
          if [ -n "$POM_PATH" ]; then
            echo "âœ… Maven detectado em: $POM_PATH"
            echo "build_system=maven" >> $GITHUB_OUTPUT
            echo "build_file=$POM_PATH" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. Tenta achar Gradle (qualquer arquivo de build)
          GRADLE_FILE=$(find . -maxdepth 3 \( -name "build.gradle" -o -name "build.gradle.kts" \) -type f | head -n 1)
          
          if [ -n "$GRADLE_FILE" ]; then
            echo "âœ… Gradle detectado em: $GRADLE_FILE"
            echo "build_system=gradle" >> $GITHUB_OUTPUT
            echo "build_file=$GRADLE_FILE" >> $GITHUB_OUTPUT
            
            # CORREÃ‡ÃƒO CRÃTICA: Busca o properties de forma INDEPENDENTE
            PROPS=$(find . -name "gradle-wrapper.properties" -type f | head -n 1)
            
            # Valor padrÃ£o seguro (Ãºltimo recurso)
            TARGET_VERSION="8.10.2"
            
            if [ -f "$PROPS" ]; then
               echo "ðŸ“„ Arquivo de propriedades encontrado: $PROPS"
               ver=$(grep -oE 'gradle-[0-9.]+(-(bin|all))?\.zip' "$PROPS" | grep -oE '[0-9]+\.[0-9]+(\.[0-9]+)?' | head -n 1)
               if [ -n "$ver" ]; then
                 TARGET_VERSION="$ver"
                 echo "âœ… VersÃ£o detectada no projeto: $TARGET_VERSION"
               else
                 echo "âš ï¸ NÃ£o foi possÃ­vel extrair versÃ£o do properties, usando default: $TARGET_VERSION"
               fi
            else
               echo "âš ï¸ Arquivo gradle-wrapper.properties nÃ£o encontrado, usando default: $TARGET_VERSION"
            fi
            
            # Salva a versÃ£o detectada para uso nos prÃ³ximos steps
            echo "detected_gradle_ver=$TARGET_VERSION" >> $GITHUB_OUTPUT
            
            # Baixa e instala a versÃ£o exata detectada (ou default)
            echo "â¬‡ï¸ Baixando Gradle $TARGET_VERSION oficial..."
            wget -q "https://services.gradle.org/distributions/gradle-${TARGET_VERSION}-bin.zip"
            unzip -q "gradle-${TARGET_VERSION}-bin.zip"
            echo "GRADLE_HOME=$PWD/gradle-${TARGET_VERSION}/bin" >> $GITHUB_ENV
            echo "$PWD/gradle-${TARGET_VERSION}/bin" >> $GITHUB_PATH
            echo "âœ… Gradle $TARGET_VERSION instalado com sucesso"
          else
             echo "âš ï¸ Nenhum build system detectado"
             echo "build_system=unknown" >> $GITHUB_OUTPUT
          fi

      # Java 21 Ã© retrocompatÃ­vel
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: 'temurin'

      # --- MAVEN: Compila e analisa ---
      - name: Maven Build and Analysis
        if: steps.setup_env.outputs.build_system == 'maven'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dmaven.test.skip=true -f ${{ steps.setup_env.outputs.build_file }} -Dsonar.projectKey=grilo-org_20260129T141729_miguelDK17_Breeze -Dsonar.projectName=20260129T141729_miguelDK17_Breeze -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org

      # --- GRADLE: Apenas compila (sem sonarqube task) ---
      - name: Gradle Build Only
        if: steps.setup_env.outputs.build_system == 'gradle'
        id: gradle_build
        continue-on-error: true
        run: |
           BUILD_DIR=$(dirname "${{ steps.setup_env.outputs.build_file }}")
           cd "$BUILD_DIR"
           
           echo "ðŸš€ Compilando com Gradle (VersÃ£o: ${{ steps.setup_env.outputs.detected_gradle_ver }})..."
           gradle -v
           
           # Compila apenas - nÃ£o roda sonarqube task pois o projeto pode nÃ£o ter o plugin
           gradle compileDebugSources -x test -x lint --no-daemon --continue || \
           gradle compileJava -x test -x lint --no-daemon --continue || \
           gradle assemble -x test -x lint --no-daemon --continue || \
           echo "âš ï¸ Build falhou, mas continuando para anÃ¡lise de cÃ³digo fonte."

      # --- ANÃLISE SONAR VIA CLI (FUNCIONA SEM PLUGIN NO PROJETO) ---
      - name: SonarCloud Scan (CLI)
        if: steps.setup_env.outputs.build_system == 'gradle'
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=grilo-org_20260129T141729_miguelDK17_Breeze
            -Dsonar.projectName=20260129T141729_miguelDK17_Breeze
            -Dsonar.organization=grilo-org
            -Dsonar.java.binaries=**/build/classes,**/build/intermediates/javac,**/build/tmp/kotlin-classes
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*.class,**/build/**,**/gradle/**
